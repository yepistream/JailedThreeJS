<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JailedThreeJS Identity Test</title>
  <style>
    :root {
      --bg: #0d1117;
      --panel: #161b22;
      --panel-2: #1f2630;
      --line: #2c3440;
      --text: #e6edf3;
      --muted: #9fb0c3;
      --accent: #54c2ff;
      --good: #68d391;
      --warn: #f6c453;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background:
        radial-gradient(1200px 700px at 8% -10%, rgba(84,194,255,0.14), transparent 60%),
        radial-gradient(900px 600px at 110% 20%, rgba(104,211,145,0.12), transparent 55%),
        var(--bg);
      color: var(--text);
      font: 13px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .app {
      min-height: 100%;
      display: grid;
      grid-template-columns: minmax(320px, 1fr) 380px;
      gap: 12px;
      padding: 12px;
    }

    .stage, .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
    }

    .stage {
      display: grid;
      grid-template-rows: auto minmax(420px, 1fr) auto;
    }

    .panel {
      display: grid;
      grid-template-rows: auto auto 1fr auto;
    }

    .bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid var(--line);
    }

    .title {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .status {
      font-size: 11px;
      color: var(--muted);
    }

    .viewport-wrap {
      padding: 12px;
      display: grid;
      gap: 10px;
      align-content: start;
    }

    .viewport {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background:
        radial-gradient(circle at 50% 10%, #243447 0%, #121821 45%, #0a0f15 100%);
      min-height: 500px;
      position: relative;
    }

    cell {
      display: block;
      width: 100%;
      height: 100%;
      position: relative;
    }

    cell > :not(canvas) { display: none; }

    .legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 11px;
    }

    .chip {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 999px;
      padding: 3px 8px;
    }

    .chip b { color: var(--text); }

    .section {
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      display: grid;
      gap: 8px;
      background: rgba(255,255,255,0.01);
    }

    .section:last-of-type { border-bottom: 0; }

    .section h2 {
      margin: 0;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .row {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 8px;
      align-items: center;
    }

    .row label {
      color: var(--muted);
      font-size: 11px;
    }

    input[type="text"] {
      width: 100%;
      background: var(--panel-2);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 8px;
      padding: 7px 9px;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(84,194,255,0.12);
    }

    .btns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid var(--line);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 8px;
      padding: 7px 10px;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      border-color: var(--accent);
      background: #263243;
    }

    button:active { transform: translateY(1px); }

    .object-list {
      display: grid;
      gap: 6px;
      max-height: 170px;
      overflow: auto;
      padding-right: 2px;
    }

    .object-item {
      width: 100%;
      text-align: left;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .object-item small {
      color: var(--muted);
      font-weight: 500;
      font-size: 10px;
    }

    .object-item.active {
      border-color: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(84,194,255,0.25);
      background: #203244;
    }

    .kv {
      display: grid;
      gap: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
    }

    .kv-row {
      display: grid;
      grid-template-columns: 130px 1fr;
      gap: 8px;
      align-items: start;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 6px 8px;
      background: rgba(255,255,255,0.015);
    }

    .kv-key {
      color: var(--muted);
      white-space: nowrap;
    }

    .kv-value {
      color: var(--text);
      word-break: break-word;
    }

    .console {
      margin: 0;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #0b1016;
      color: #d9e2ec;
      padding: 8px;
      min-height: 120px;
      max-height: 180px;
      overflow: auto;
      font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space: pre-wrap;
    }

    .hint {
      color: var(--muted);
      font-size: 11px;
    }

    .good { color: var(--good); }
    .warn { color: var(--warn); }

    @media (max-width: 980px) {
      .app {
        grid-template-columns: 1fr;
      }
      .viewport { min-height: 360px; }
      .panel { grid-template-rows: auto auto auto auto; }
    }
  </style>

  <style id="demo-scene-style">
    #cam {
      --position: (0, 2.2, 8);
      --rotation: (-0.18, 0, 0);
    }

    #sun {
      --position: (5, 8, 6);
      --intensity: 2.2;
      --color: (1, 0.95, 0.9);
    }

    #fill {
      --intensity: 0.45;
      --color: (0.35, 0.45, 0.8);
    }

    #grid {
      --scale: (1.4, 1, 1.4);
      --position: (0, -1, 0);
    }

    .scene-object {
      --geometry: @cube;
      --scale: (1, 1, 1);
      --transition: 220ms ease-out;
    }

    .scene-object:hover {
      --scale: (1.08, 1.08, 1.08);
    }

    .primary {
      --material-color: (0.30, 0.72, 1.0);
    }

    .secondary {
      --material-color: (0.96, 0.56, 0.28);
    }

    .highlight {
      --scale: (1.03, 1.03, 1.03);
    }

    #box-a {
      --position: (-2.1, 0, 0);
      --rotation: (0, 0.35, 0);
    }

    #box-b {
      --position: (0, 0, 0);
      --rotation: (0, -0.1, 0);
    }

    #box-c {
      --position: (2.1, 0, 0);
      --rotation: (0, 0.12, 0);
    }

    .selected {
      --material-color: (0.95, 0.95, 1.0);
      --scale: (1.12, 1.12, 1.12);
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="stage">
      <div class="bar">
        <div class="title">JailedThreeJS Identity Test (Fresh Demo)</div>
        <div class="status" id="boot-status">Booting...</div>
      </div>

      <div class="viewport-wrap">
        <div class="viewport">
          <cell id="scene-cell">
            <perspectivecamera id="cam" render></perspectivecamera>
            <ambientlight id="fill"></ambientlight>
            <directionallight id="sun"></directionallight>
            <gridhelper id="grid"></gridhelper>

            <mesh id="box-a" class="scene-object primary"></mesh>
            <mesh id="box-b" class="scene-object secondary highlight"></mesh>
            <mesh id="box-c" class="scene-object primary"></mesh>
          </cell>
        </div>

        <div class="legend">
          <span class="chip"><b>Expectation:</b> `Object3D.name === DOM id`</span>
          <span class="chip"><b>Expectation:</b> `Object3D.classList === DOM class list`</span>
        </div>
      </div>

      <div class="bar">
        <div class="hint">Hover objects for CSS `:hover`. Use the controls to rename IDs / classes and verify runtime mapping updates live.</div>
      </div>
    </section>

    <aside class="panel">
      <div class="bar">
        <div class="title">Objects</div>
        <div class="status" id="object-count">0</div>
      </div>

      <section class="section">
        <h2>Pick Object</h2>
        <div class="object-list" id="object-list"></div>
      </section>

      <section class="section">
        <h2>Mutate DOM Identity</h2>
        <div class="row">
          <label for="id-input">DOM id</label>
          <input id="id-input" type="text" placeholder="box-a" />
        </div>
        <div class="row">
          <label for="class-input">DOM class</label>
          <input id="class-input" type="text" placeholder="scene-object primary" />
        </div>
        <div class="btns">
          <button id="apply-identity">Apply To Selected</button>
          <button id="append-class">Append `highlight`</button>
          <button id="remove-highlight">Remove `highlight`</button>
        </div>
        <div class="hint">Changes are applied to the DOM element, then read back from the runtime convict.</div>
      </section>

      <section class="section">
        <h2>Runtime Readout</h2>
        <div class="kv" id="runtime-kv"></div>
        <div class="btns">
          <button id="verify-mapping">Run Mapping Check</button>
          <button id="spin-selected">Spin Selected</button>
        </div>
        <pre class="console" id="log">Ready.</pre>
      </section>

      <div class="bar">
        <div class="hint">This page is a fresh test page and does not reuse the previous editor UI.</div>
      </div>
    </aside>
  </div>

  <script type="module">
    import './module/main.js';
    import Cell from './module/cell.js';

    const cellEl = document.getElementById('scene-cell');
    const bootStatusEl = document.getElementById('boot-status');
    const objectListEl = document.getElementById('object-list');
    const objectCountEl = document.getElementById('object-count');
    const idInputEl = document.getElementById('id-input');
    const classInputEl = document.getElementById('class-input');
    const runtimeKvEl = document.getElementById('runtime-kv');
    const logEl = document.getElementById('log');

    const applyIdentityBtn = document.getElementById('apply-identity');
    const appendClassBtn = document.getElementById('append-class');
    const removeHighlightBtn = document.getElementById('remove-highlight');
    const verifyMappingBtn = document.getElementById('verify-mapping');
    const spinSelectedBtn = document.getElementById('spin-selected');

    let cell = null;
    let activeId = null;
    let spinFn = null;

    function log(message, kind = '') {
      const time = new Date().toLocaleTimeString();
      const prefix = kind ? `[${kind}] ` : '';
      logEl.textContent = `${time} ${prefix}${message}\n${logEl.textContent}`.trim();
    }

    function getSceneObjectElements() {
      return Array.from(cellEl.querySelectorAll('.scene-object'));
    }

    function getConvictById(id) {
      if (!cell || !id) return null;
      return cell.getConvictById(id) || null;
    }

    function safeJson(value) {
      try {
        return JSON.stringify(value);
      } catch {
        return String(value);
      }
    }

    function renderRuntimeReadout() {
      const domEl = activeId ? document.getElementById(activeId) : null;
      const convict = domEl ? getConvictById(domEl.id) : null;

      if (!domEl || !convict) {
        runtimeKvEl.innerHTML = '';
        addKv('selectedDomId', 'null');
        addKv('convictFound', 'false');
        return;
      }

      const convictClassList = Array.isArray(convict.classList)
        ? convict.classList
        : (Array.isArray(convict.userData?.classList) ? convict.userData.classList : []);

      runtimeKvEl.innerHTML = '';
      addKv('selectedDomId', safeJson(domEl.id));
      addKv('selectedDomClass', safeJson(domEl.className));
      addKv('convict.name', safeJson(convict.name));
      addKv('convict.classList', safeJson(convictClassList));
      addKv('convict.userData.domId', safeJson(convict.userData?.domId));
      addKv('convict.userData.classList', safeJson(convict.userData?.classList));
      addKv('name===id', String(convict.name === domEl.id));
      addKv('classList===DOM', String(safeJson(convictClassList) === safeJson(Array.from(domEl.classList))));
    }

    function addKv(key, value) {
      const row = document.createElement('div');
      row.className = 'kv-row';
      const k = document.createElement('div');
      k.className = 'kv-key';
      k.textContent = key;
      const v = document.createElement('div');
      v.className = 'kv-value';
      v.textContent = value;
      row.append(k, v);
      runtimeKvEl.appendChild(row);
    }

    function refreshObjectList() {
      const objects = getSceneObjectElements();
      objectListEl.innerHTML = '';
      objectCountEl.textContent = `${objects.length} objects`;

      for (const el of objects) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `object-item${el.id === activeId ? ' active' : ''}`;
        btn.dataset.targetId = el.id;

        const left = document.createElement('span');
        left.textContent = el.id || '(no id)';

        const right = document.createElement('small');
        right.textContent = el.className || '(no class)';

        btn.append(left, right);
        objectListEl.appendChild(btn);
      }
    }

    function setSelectedVisual(id) {
      for (const el of getSceneObjectElements()) {
        el.classList.toggle('selected', !!id && el.id === id);
      }
    }

    function selectObject(id) {
      activeId = id;
      const el = id ? document.getElementById(id) : null;
      idInputEl.value = el?.id || '';
      classInputEl.value = el?.className || '';
      setSelectedVisual(id);
      refreshObjectList();
      renderRuntimeReadout();
    }

    function applyIdentityChanges() {
      const el = activeId ? document.getElementById(activeId) : null;
      if (!el) {
        log('No active object selected.', 'warn');
        return;
      }

      const prevId = el.id;
      const nextId = idInputEl.value.trim();
      const nextClassName = classInputEl.value.trim();

      if (!nextId) {
        log('ID cannot be empty in this demo (runtime lookup uses id for selection).', 'warn');
        return;
      }

      if (nextId !== prevId && document.getElementById(nextId)) {
        log(`ID "${nextId}" already exists.`, 'warn');
        return;
      }

      el.id = nextId;
      el.className = nextClassName;
      activeId = nextId;

      const convict = getConvictById(nextId);
      log(`Updated DOM identity: id ${safeJson(prevId)} -> ${safeJson(nextId)}, class -> ${safeJson(nextClassName)}`);
      if (!convict) {
        log('Runtime convict lookup failed after rename.', 'warn');
      }

      selectObject(nextId);
    }

    function mutateClass(fn, label) {
      const el = activeId ? document.getElementById(activeId) : null;
      if (!el) {
        log('No active object selected.', 'warn');
        return;
      }
      const list = new Set(Array.from(el.classList));
      fn(list);
      el.className = Array.from(list).join(' ');
      classInputEl.value = el.className;
      renderRuntimeReadout();
      refreshObjectList();
      log(`${label}: ${safeJson(el.className)}`);
    }

    function verifyMapping() {
      const el = activeId ? document.getElementById(activeId) : null;
      if (!el) {
        log('No active object selected.', 'warn');
        return;
      }

      const convict = getConvictById(el.id);
      if (!convict) {
        log(`Mapping check failed: cell.getConvictById(${safeJson(el.id)}) returned null`, 'warn');
        return;
      }

      const runtimeClasses = Array.isArray(convict.classList)
        ? convict.classList
        : (Array.isArray(convict.userData?.classList) ? convict.userData.classList : []);
      const domClasses = Array.from(el.classList);

      const checks = [
        ['convict.name === el.id', convict.name === el.id],
        ['convict.userData.domId === el.id', convict.userData?.domId === el.id],
        ['convict.classList matches DOM classes', safeJson(runtimeClasses) === safeJson(domClasses)],
        ['convict.userData.classList matches DOM classes', safeJson(convict.userData?.classList) === safeJson(domClasses)]
      ];

      const failed = checks.filter(([, ok]) => !ok);
      renderRuntimeReadout();
      if (failed.length === 0) {
        log(`Mapping check passed for ${safeJson(el.id)}.`, 'ok');
      } else {
        log(`Mapping check failed for ${safeJson(el.id)} -> ${failed.map(([name]) => name).join(', ')}`, 'warn');
      }
    }

    function toggleSpinSelected() {
      if (!cell) return;
      const convict = activeId ? getConvictById(activeId) : null;
      if (!convict) {
        log('Select an object before spinning.', 'warn');
        return;
      }

      if (spinFn) {
        cell.removeUpdateFunction(spinFn);
        spinFn = null;
      }

      spinFn = function () {
        convict.rotation.y += 0.02;
      };
      cell.addUpdateFunction(spinFn);
      log(`Spinning ${safeJson(activeId)} (replace previous spin target).`);
    }

    function installViewportSelection() {
      cellEl.addEventListener('click', (evt) => {
        const domTarget = evt.target;
        if (!(domTarget instanceof Element)) return;
        const convict = domTarget.convict;
        const objectDom = convict?.userData?.domEl;
        if (!objectDom) return;
        if (!objectDom.classList.contains('scene-object')) return;
        selectObject(objectDom.id);
        log(`Selected from viewport: ${safeJson(objectDom.id)}`);
      });
    }

    function installDemoAnimation() {
      const a = getConvictById('box-a');
      const b = getConvictById('box-b');
      const c = getConvictById('box-c');
      let t = 0;

      cell.addUpdateFunction(function demoMotion() {
        t += 0.015;
        if (a) a.rotation.x = Math.sin(t) * 0.2;
        if (b) b.rotation.y += 0.008;
        if (c) c.rotation.z = Math.cos(t * 0.8) * 0.18;
      });
    }

    objectListEl.addEventListener('click', (evt) => {
      const btn = evt.target.closest('.object-item');
      if (!btn || !objectListEl.contains(btn)) return;
      selectObject(btn.dataset.targetId || null);
      log(`Selected from list: ${safeJson(btn.dataset.targetId || null)}`);
    });

    applyIdentityBtn.addEventListener('click', applyIdentityChanges);
    appendClassBtn.addEventListener('click', () => mutateClass(set => set.add('highlight'), 'Added class highlight'));
    removeHighlightBtn.addEventListener('click', () => mutateClass(set => set.delete('highlight'), 'Removed class highlight'));
    verifyMappingBtn.addEventListener('click', verifyMapping);
    spinSelectedBtn.addEventListener('click', toggleSpinSelected);

    window.addEventListener('DOMContentLoaded', () => {
      window.JThree?.init_convert?.();
      cell = Cell.getCell(cellEl);

      if (!cell) {
        bootStatusEl.textContent = 'Failed to boot';
        log('Cell boot failed.', 'warn');
        return;
      }

      bootStatusEl.innerHTML = '<span class="good">Ready</span>';
      installViewportSelection();
      installDemoAnimation();
      refreshObjectList();
      selectObject('box-b');
      verifyMapping();
      log('Fresh test page loaded. This does not use the previous editor UI.');
    });
  </script>
</body>
</html>
